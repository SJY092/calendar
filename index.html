//è¡Œäº‹æ›†

<script type="module">
    import { createRecord, readRecords, updateRecord, deleteRecord } from './supabaseService.js'

    const tableName = 'è¡Œäº‹æ›†'
    let userId = null
    let userName = null

    // === åˆå§‹åŒ– LIFF ä¸¦ç™»å…¥ ===
    window.onload = async () => {
      try {
        await liff.init({ liffId: '2008228534-vAzlOYLb' })

        if (!liff.isLoggedIn()) {
          liff.login()
          return
        }

        const profile = await liff.getProfile()
        userId = profile.userId
        userName = profile.displayName

        document.getElementById('user').textContent = `ğŸ‘¤ ä½¿ç”¨è€…ï¼š${userName}`
        await loadRecords()
      } catch (err) {
        console.error('LIFF åˆå§‹åŒ–éŒ¯èª¤:', err)
      }
    }

    // === è¼‰å…¥è¡Œç¨‹ ===
    async function loadRecords() {
      const { data, error } = await readRecords(tableName, { elder_user_id: userId })
      const list = document.getElementById('list')
      list.innerHTML = ''
      if (error) {
        list.innerHTML = `<li>âŒ è¼‰å…¥å¤±æ•—ï¼š${error.message}</li>`
        return
      }

      if (data.length === 0) {
        list.innerHTML = '<li>å°šç„¡è¡Œç¨‹è³‡æ–™</li>'
        return
      }

      data.forEach(item => {
        const dateObj = new Date(item.schedule_time)
        const dateStr = dateObj.toLocaleDateString('zh-TW')
        const timeStr = dateObj.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })

        const li = document.createElement('li')
        li.innerHTML = `
          <strong>${dateStr} ${timeStr}</strong>ï¼š${item.schedule_note}
          <button onclick="editRecord('${item.uuid}', '${item.schedule_note}')">âœï¸</button>
          <button onclick="removeRecord('${item.uuid}')">ğŸ—‘ï¸</button>
        `
        list.appendChild(li)
})
    }

    // === æ–°å¢è¡Œç¨‹ ===
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('addBtn').addEventListener('click', async () => {
        const date = document.getElementById('date').value
        const time = document.getElementById('time').value
        const note = document.getElementById('schedule_note').value

        if (!date || !time || !note) return alert('è«‹å¡«å¯«å®Œæ•´')

        const schedule_time = new Date(`${date}T${time}:00`).toISOString()

        const { error } = await createRecord(tableName, [{
          elder_user_id: userId,
          elder_name: userName,
          schedule_time: schedule_time,
          schedule_note: note,
          is_reminded: false
        }])

        if (error) alert('æ–°å¢å¤±æ•—ï¼š' + error.message)
        else {
          alert('âœ… æ–°å¢æˆåŠŸ')
          document.getElementById('schedule_note').value = ''
          await loadRecords()
        }
      })
    })

    // === ä¿®æ”¹è¡Œç¨‹ ===
    window.editRecord = async (uuid, oldNote) => {
      const newNote = prompt('è«‹è¼¸å…¥æ–°å‚™è¨»å…§å®¹ï¼š', oldNote)
      if (!newNote || newNote === oldNote) return
      const { error } = await updateRecord(tableName, 'uuid', uuid, { schedule_note: newNote })
      if (error) alert('æ›´æ–°å¤±æ•—ï¼š' + error.message)
      else {
        alert('âœ… æ›´æ–°æˆåŠŸ')
        loadRecords()
      }
    }

    // === åˆªé™¤è¡Œç¨‹ ===
    window.removeRecord = async (uuid) => {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿ')) return
      const { error } = await deleteRecord(tableName, 'uuid', uuid)
      if (error) alert('åˆªé™¤å¤±æ•—ï¼š' + error.message)
      else {
        alert('âœ… å·²åˆªé™¤')
        loadRecords()
      }
    }
  </script>